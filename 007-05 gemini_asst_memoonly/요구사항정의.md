# 007-05 Gemini Assistant 메모 전용 봇 - 요구사항 정의

작성일: 2025-10-07
작성자: davidlikessangria

## 1. 개요
Discord 채널에서 감지한 메시지를 Google Gemini 모델로 정제한 뒤, 원문과 정제본을 함께 Notion 데이터베이스에 저장하는 간소화된 메모 봇을 구축한다. 기존 007-04 통합 프로젝트에서 메모 관련 플로우만 유지하여 운영 복잡도를 낮추고, Gemini 기반 요약/정제 기능을 강화한다.

## 2. 시스템 구성
- **Discord Bot**: 메시지 감지 및 사용자 응답 담당. `discord.py` 기반.
- **Gemini Refiner**: LangChain + `langchain-google-genai`를 이용해 메시지를 정제.
- **Notion Agent**: Notion API를 통해 메모 저장. 원문/정제본/Discord 링크를 포함한 페이지 생성.
- **LangGraph State Manager**: 최소한의 세션 관리와 메트릭 수집 유지.

프로젝트 구조: `007-05 gemini_asst_memoonly/`
- `improved_discord_bot.py`: 메인 봇 실행 및 전체 워크플로우
- `langgraph_agents/services/gemini_refiner.py`: Gemini 정제 모듈
- `langgraph_agents/services/notion_service.py`: 노션 저장 에이전트
- 기타: 상태/에이전트 기초 모듈, 실행 스크립트, README 등

## 3. 주요 기능 요구사항
1. **메시지 감지 및 필터링**
   - Discord 메시지를 실시간 감지한다.
   - 봇 자신의 메시지와 차단 채널(기본: `11-success-logic`)은 무시한다.
   - 특정 타겟 채널 ID가 설정되어 있으면 해당 채널에서만 동작한다.

2. **Gemini 정제 기능**
   - 환경 변수 `GEMINI_API_KEY`가 설정되어 있어야 한다.
   - 기본 모델: `gemini-1.5-flash` (변경 가능).
   - 메시지 내용을 LangChain Runnable 체인으로 전달해 정제된 한국어 문단을 생성한다.
   - 정제 실패 시 원문을 그대로 사용하고 Discord 응답에 경고 메시지를 포함한다.

3. **Notion 저장**
   - Notion API 키와 데이터베이스 ID를 `.env`에 설정한다.
   - 생성되는 페이지에는 다음 정보가 포함되어야 한다:
     - 제목: 정제본 또는 원문의 첫 줄(최대 100자)
     - Description 필드: Discord 링크, 원문, 정제본을 텍스트로 기록
     - 본문 블록(children):
       - Discord 메시지 링크(있을 경우)
       - "원문" 헤딩과 원문 텍스트 단락
       - "정제본" 헤딩과 정제 텍스트 단락
   - 실패 시 사용자에게 오류 메시지를 전달한다.

4. **Discord 응답**
   - 처리 시작 시 진행 안내 메시지를 전송한다.
   - 저장 완료 후 Notion URL, 원문/정제본 요약(최대 600자) 등 결과를 답변한다.
   - 오류 발생 또는 정제 실패 시 상황에 맞는 경고/오류 메시지를 전달한다.

5. **상태 관리 및 로그**
   - LangGraph `state_manager`를 사용해 세션 생성/종료, 실행 결과 기록, 메트릭 관리.
   - 로깅으로 주요 이벤트 및 오류를 `memo_discord_bot.log`에 기록한다.

## 4. 환경 변수 및 설정
`.env` 위치: `langgraph_agents/.env`

필수 변수
- `DISCORD_TOKEN`
- `NOTION_API_KEY`
- `NOTION_DATABASE_ID`
- `GEMINI_API_KEY`

선택 변수 (기본값 존재)
- `DISCORD_CHANNEL_ID`
- `BLOCKED_CHANNEL_ID`
- `NOTION_DEFAULT_STATUS`
- `NOTION_DEFAULT_PRIORITY`
- `GEMINI_LLM_MODEL`
- `GEMINI_TEMPERATURE`
- `GEMINI_MAX_TOKENS`

## 5. 비기능 요구사항
- Python 3.11+ 환경에서 실행 가능해야 한다.
- 의존성: `discord.py`, `notion-client`, `langchain`, `langchain-google-genai`, `python-dotenv`, `pydantic` 등.
- 11-success-logic 채널에는 어떤 경우에도 메시지를 전송하거나 처리하지 않는다.
- LLM 호출 실패 시 재시도 대신 원문 기반 처리로 대체하여 사용자 경험을 보장한다.

## 6. 향후 확장 고려사항
- 정제 스타일 사용자 지정(프롬프트 변수화) 기능 추가
- 노션 템플릿 적용 또는 사용자별 데이터베이스 분리
- LangGraph 의존성을 제거하고 경량화할 필요가 있는지 재검토
- Discord 명령어를 통한 상태 조회/설정 변경 기능 추가

